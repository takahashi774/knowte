const html = document.querySelector('html');

var loading_flg = false;
// 現在読み込んでいる記事のインデックス
var PostIndex = 1;
// 一度に読み込む記事数
var PostNum = 10;

// 記事を非同期取得して、ニュースリストに追加する関数
function addPosts() {
    $("#news_list").append(`<div class="loading">読込中...</div>`);

    // AJAXを使って、ローカルのPHP（を経由してNewsAPIから情報を取得）にアクセス
    // NewsAPIのURLを送る（テクノロジーカテゴリーのヘッドラインニュースを取得するURL）
    $.ajax({
        type: "GET",
        url: "ajax",
        dataType : "json",
    })
    // Ajaxリクエストが成功した場合
    .done(function(data) {
        // 読込中を削除
        $('#news_list .loading').remove();

        // ニュースを表示
        for (var i=0; i<data.length; i++) {
            $("#news_list").append(
                `<div>
                    <a class="news_block" href="${data[i]["url"]}" target="_blank">
                        <img src="${data[i]["urlToImage"]}">
                        <h2 class="title">${data[i]["title"]}</h2>
                        <p class="description">${data[i]["description"]}</p>
                        <p class="author">${data[i]["author"]}</p>
                    </a>
                </div>`
            );
        }

        // 読込が終わったので、インデックスを進める
        PostIndex += 1;

        // 読込中フラグをオフに戻す
        loading_flg = false;
    })
    // Ajaxリクエストが失敗した場合
    .fail(function(XMLHttpRequest, textStatus, errorThrown) {
        alert(errorThrown);
    });
}

// ページを開いた時
$(function() {
    addPosts();
});

// スクロールが発生した時
$(window).scroll(function() {
    // 読込処理中ではないか判定
    if (!loading_flg) {

        // 画面に見えている最上部の座標が分かる = [bodyの高さ] - [windowの高さ]
        var bottomPoint = document.body.clientHeight - window.innerHeight;
        // スクロール量を取得
        var currentPos = window.pageYOffset;
        // スクロール量が最下部の位置を過ぎたか判定
        if (bottomPoint-300 <= currentPos) {
            loading_flg = true;

            // スクロールが画面末端に到達している時
            addPosts();
            
            // 末端に到達を検知！
            console.log(`ページ末端への到達を検知！\nbottomPoint:${bottomPoint}\ncurrentPos:${currentPos}`);
        }
    }
});